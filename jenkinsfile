pipeline {
    agent any

    environment {
        PROJECT_NAME = 'project-serverless-and-cloud-architectures'
        SERVICES = 'frontend user-service recipe-service rating-service favorite-service api-gateway reverse-proxy'
    }

    stages {
        stage('Clean Containers') {
            steps {
                echo 'Stopping and removing containers...'
                sh "docker compose --project-name $PROJECT_NAME down"
            }
        }

        stage('Build Frontend and Services') {
            steps {
                echo 'Building Docker images...'
                sh "docker compose --project-name $PROJECT_NAME build $SERVICES"
            }
        }

        stage('Start Containers') {
            steps {
                echo 'Starting containers...'
                sh "docker compose --project-name $PROJECT_NAME up -d $SERVICES"
            }
        }

        stage('Check Status') {
            steps {
                echo 'Listing running containers...'
                sh 'docker ps'
            }
        }
    }

    post {
        failure {
            echo '‚ùå Build failed. Cleaning up...'
            sh "docker compose --project-name $PROJECT_NAME down"
        }
    }
}
